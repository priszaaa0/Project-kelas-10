<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-white font-sans" x-data="{ showModal: false, loading: false, success: false, selected: { name: 'DANA', image: 'pembayaran/dana.jpg' }, alamat: '' }">

  <!-- Navbar -->
  <header class="bg-pink-100 py-2 px-4 flex justify-between items-center text-sm text-pink-500 relative">
    <a href="home.html" class="flex items-center gap-1 text-pink-500 absolute left-4 top-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      <span>Kembali</span>
    </a>
    <span class="mx-auto">Checkout</span>
    <span class="invisible">...</span>
  </header>

  <!-- Main Content -->
  <main class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto">
    <section class="md:col-span-2 space-y-4" id="cartItems"></section>

    <aside class="border border-pink-300 p-6 space-y-4 h-fit">
      <div class="flex justify-between text-sm">
        <span>Subtotal</span><span id="total">Rp 0</span>
      </div>
      <div class="flex justify-between text-sm">
        <span>Pajak</span><span id="tax">Rp 0</span>
      </div>
      <hr class="border-t border-pink-200">
      <div class="flex justify-between font-semibold">
        <span>Total</span><span id="grandTotal">Rp 0</span>
      </div>

      <!-- Metode Pembayaran -->
      <div>
        <label class="block text-sm mb-1">Metode Pembayaran</label>
        <div x-data="{ open: false }" class="relative w-full">
          <button @click="open = !open" class="w-full border border-pink-300 rounded p-2 flex items-center gap-2 bg-white">
            <img :src="selected.image" :alt="selected.name" class="h-5">
            <span class="text-sm" x-text="selected.name"></span>
            <svg class="ml-auto w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div x-show="open" @click.away="open = false" class="absolute mt-1 w-full bg-white border border-pink-300 rounded shadow z-10">
            <ul class="max-h-60 overflow-y-auto">
              <template x-for="option in [
                { name: 'DANA', image: 'pembayaran/dana.jpg' },
                { name: 'OVO', image: 'pembayaran/ovo.jpg' },
                { name: 'GoPay', image: 'pembayaran/gopay.jpg' },
                { name: 'COD', image: 'pembayaran/cod.jpg' }
              ]" :key="option.name">
                <li @click="selected = option; open = false"
                    class="flex items-center px-4 py-2 hover:bg-pink-50 cursor-pointer">
                  <img :src="option.image" :alt="option.name" class="h-5 mr-2">
                  <span class="text-sm" x-text="option.name"></span>
                </li>
              </template>
            </ul>
          </div>
        </div>
      </div>

      <!-- Alamat -->
      <div class="mt-4">
        <label class="flex items-center gap-2 text-sm text-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 12.414M12 12c2.485 0 4.5-2.015 4.5-4.5S14.485 3 12 3 7.5 5.015 7.5 7.5 9.515 12 12 12z" />
          </svg>
          Alamat
        </label>
        <input type="text" id="alamat" class="mt-1 w-full border border-pink-300 rounded px-3 py-2 text-sm" placeholder="Contoh: Jl. Sukatani No. 10">
      </div>

      <button id="checkoutBtn" class="bg-pink-100 text-pink-600 w-full py-2 rounded text-lg font-semibold hover:bg-pink-200">
        Beli Sekarang
      </button>
    </aside>
  </main>

  <!-- SCRIPT -->
  <script>
    const isFromDetail = localStorage.getItem("fromDetail") === "true";
    const produkCheckout = isFromDetail ? JSON.parse(localStorage.getItem("checkoutProduct")) : null;
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const cartContainer = document.getElementById("cartItems");

    function formatRupiah(angka) {
      return "Rp " + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function safeInt(val, fallback = 0) {
      const num = parseInt(val);
      return isNaN(num) ? fallback : num;
    }

    let total = 0;

    async function renderCart() {
      if (isFromDetail && produkCheckout) {
        const response = await fetch(`https://fakestoreapi.com/products/${produkCheckout.id}`);
        const data = await response.json();
        const price = safeInt(produkCheckout.price || data.price);
        const qty = safeInt(produkCheckout.qty || 1, 1);
        const subtotal = price * qty;
        total = subtotal;

        cartContainer.innerHTML = `
          <div class="flex gap-4 bg-white p-4 rounded shadow relative">
            <img src="${produkCheckout.image}" class="w-32 h-auto max-h-32 object-contain border rounded" />
            <div>
              <h2 class="text-xl font-bold mb-1">${data.title}</h2>
              <p class="text-pink-600">Harga Satuan: ${formatRupiah(price)}</p>
              <p class="text-gray-700">Jumlah: ${qty}</p>
              <p class="text-lg font-semibold mt-2">Total: ${formatRupiah(subtotal)}</p>
            </div>
            <button id="hapusDetail" class="absolute top-2 right-2 text-red-500 text-sm hover:underline">Hapus</button>
          </div>
        `;

        document.getElementById("hapusDetail").addEventListener("click", function () {
          localStorage.removeItem("checkoutProduct");
          localStorage.setItem("fromDetail", "false");
          location.reload();
        });
      } else if (cart.length > 0) {
        cartContainer.innerHTML = "";

        cart.forEach((item, index) => {
          const price = safeInt(item.price);
          const qty = safeInt(item.qty, 1);
          const subtotal = price * qty;
          total += subtotal;

          const itemDiv = document.createElement("div");
          itemDiv.className = "flex gap-4 bg-white p-4 rounded shadow items-start";

          itemDiv.innerHTML = `
            <input type="checkbox" class="item-checkbox hidden" checked data-index="${index}" />
            <img src="${item.image}" class="w-24 h-auto max-h-24 object-contain border rounded" />
            <div class="flex-1">
              <h2 class="text-lg font-bold mb-1">${item.title || 'Produk'}</h2>
              <p class="text-gray-700 text-sm">Harga: ${formatRupiah(price)} x ${qty}</p>
              <p class="text-sm font-semibold mt-1">Subtotal: ${formatRupiah(subtotal)}</p>
            </div>
            <button class="hapus-btn text-red-500 hover:underline" data-index="${index}">Hapus</button>
          `;

          cartContainer.appendChild(itemDiv);
        });

        document.querySelectorAll(".hapus-btn").forEach(btn => {
          btn.addEventListener("click", function () {
            const index = this.getAttribute("data-index");
            cart.splice(index, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            location.reload();
          });
        });
      } else {
        cartContainer.innerHTML = "<p class='text-gray-500'>Keranjang kamu kosong.</p>";
      }

      const pajak = Math.floor(total * 0.1);
      const grandTotal = total + pajak;

      document.getElementById("total").textContent = formatRupiah(total);
      document.getElementById("tax").textContent = formatRupiah(pajak);
      document.getElementById("grandTotal").textContent = formatRupiah(grandTotal);

       function formatRupiah(number) {
      const rate = 15000;
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(number * rate);
    }

      localStorage.removeItem("fromDetail");
    }

    renderCart();

    document.getElementById("checkoutBtn").addEventListener("click", function () {
      const alamat = document.getElementById("alamat").value.trim();
      let produkDipilih = false;

      if (isFromDetail && produkCheckout) {
        produkDipilih = true;
      } else if (cart.length > 0) {
        const checkboxes = document.querySelectorAll(".item-checkbox:checked");
        produkDipilih = checkboxes.length > 0;
      }

      if (!produkDipilih) {
        alert("Pilih setidaknya satu produk.");
        return;
      }

      if (alamat === "") {
        alert("Silakan isi alamat pengiriman terlebih dahulu.");
        return;
      }

      if (isFromDetail && produkCheckout) {
        localStorage.removeItem("checkoutProduct");
        localStorage.setItem("fromDetail", "false");
      } else {
        const checkboxes = document.querySelectorAll(".item-checkbox:checked");
        const selectedIndexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
        cart = cart.filter((_, index) => !selectedIndexes.includes(index));
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      alert("Pembayaran berhasil!");
      location.reload();
    });
  </script>
</body>
</html>
